<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Анализ главных компонент</title>
    <meta charset="utf-8" />
    <meta name="author" content="Марина Варфоломеева" />
    <meta name="author" content="Анастасия Лянгузова" />
    <script src="libs/header-attrs-2.27/header-attrs.js"></script>
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/tamu-fonts.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/ninjutsu.css" rel="stylesheet" />
    <link href="libs/tile-view-0.2.6/tile-view.css" rel="stylesheet" />
    <script src="libs/tile-view-0.2.6/tile-view.js"></script>
    <script src="libs/fabric-4.3.1/fabric.min.js"></script>
    <link href="libs/xaringanExtra-scribble-0.0.1/scribble.css" rel="stylesheet" />
    <script src="libs/xaringanExtra-scribble-0.0.1/scribble.js"></script>
    <script>document.addEventListener('DOMContentLoaded', function() { window.xeScribble = new Scribble({"pen_color":["#FF0000"],"pen_size":3,"eraser_size":30,"palette":[]}) })</script>
    <script src="libs/mark.js-8.11.1/mark.min.js"></script>
    <link href="libs/xaringanExtra-search-0.0.1/search.css" rel="stylesheet" />
    <script src="libs/xaringanExtra-search-0.0.1/search.js"></script>
    <script>window.addEventListener('load', function() { window.xeSearch = new RemarkSearch({"position":"bottom-left","caseSensitive":false,"showIcon":false,"autoSearch":true}) })</script>
    <script src="libs/xaringanExtra-progressBar-0.0.1/progress-bar.js"></script>
    <script src="libs/freezeframe-5.0.2/freezeframe.min.js"></script>
    <script src="libs/xaringanExtra-freezeframe-0.0.1/freezeframe-init.js"></script>
    <script id="xaringanExtra-freezeframe-options" type="application/json">{"selector":"img[src$=\"gif\"]","trigger":"click","overlay":false,"responsive":true,"warnings":true}</script>
    <link href="libs/tachyons-4.12.0/tachyons.min.css" rel="stylesheet" />
    <!-- https://github.com/fnaufel/xaringan-smartify-->
    <script
    			  src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    			  integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8="
    			  crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/fnaufel/xaringan-smartify/smartify.min.js"></script>
    <link rel="stylesheet" href="assets/xaringan-themer.css" type="text/css" />
    <link rel="stylesheet" href="assets/xaringan.css" type="text/css" />
    <link rel="stylesheet" href="assets/scrollable.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: middle, left, inverse, title-slide

.title[
# Анализ главных компонент
]
.subtitle[
## Математические модели в зоологии
]
.author[
### Марина Варфоломеева
]
.author[
### Анастасия Лянгузова
]

---




class: middle, center, inverse

## Ординация на примере метода главных компонент

---

### Вы сможете

- Проводить анализ главных компонент;
- Снижать размерность данных, отбирая меньшее число главных компонент;
- Оценивать долю объясненной изменчивости;
- Интерпретировать компоненты по значениям факторных нагрузок;
- Строить ординацию объектов в пространстве главных компонент;
- Извлекать значения факторов объектов для дальнейшего использования с другими видами анализов.

---

class: middle, center, inverse

# Общая характеристика многомерных методов 

---

## Почему нужны многомерные методы?

Пусть у нас имеется две группы объектов, у которых мы изучили некий признак. Мы хотим тестировать гипотезу о том, что эти две группы различаются.  

Вспомним логику тестирования гипотез.

&lt;img src="07_pca_files/figure-html/unnamed-chunk-1-1.png" style="display: block; margin: auto;" /&gt;

---

## Почему нужны многомерные методы?

Теперь представим, что наш объект, по своей природе, не может быть описан только по одному признаку:

- Сообщества (признаки --- виды)
- Форма тела (признаки --- размеры тех или иных частей)
- Социальная активность животного (признаки --- проявление того или иного паттерна)
- Общественное мнение (признаки --- ответы на разные вопросы анкет)
- Транскриптом (признаки --- транскрипты)

---

class: middle, center, inverse

# Снижение размерности многомерных данных: анализ главных компонент (PCA)

---

## Анализ главных компонент --- способ снижения размерности

.pull-left[
### Многомерные исходные данные


```
    x1   x2
1 21.1 21.3
2 21.8 19.8
3 22.4 19.2
4 26.7 21.9
5 27.2 24.7
6 27.4 25.3
```


![](07_pca_files/figure-html/unnamed-chunk-2-1.png)&lt;!-- --&gt;
]

.pull-right[
В этом примере для простоты используются двумерные данные, т.е. у каждого наблюдения (строки) есть два свойства (столбцы). Например, это могут быть свойства деревьев: x1 --- диаметр ствола, x2 --- высота ствола.
]

---

## Центрирование

&gt; Из каждого значения переменной вычитают ее среднее значение.



.pull-left-33[
Центрированные данные:


```
        x1   x2
[1,] -12.6 -1.9
[2,] -11.9 -3.4
[3,] -11.3 -4.0
[4,]  -7.0 -1.3
[5,]  -6.5  1.5
[6,]  -6.3  2.1
```
]

.pull-right[

![](07_pca_files/figure-html/unnamed-chunk-5-1.png)&lt;!-- --&gt;
]

Если центрировать данные (вычесть среднее  x1  =  33.7, среднее  x2  =  23.2), то центр координат переместится в точку `\((\bar x _{1}, \bar x _{2})\)`.

---

## Матрица ковариаций между признаками

.pull-left-33[

Исходные данные:


```
    x1   x2
1 21.1 21.3
2 21.8 19.8
3 22.4 19.2
4 26.7 21.9
5 27.2 24.7
6 27.4 25.3
```
]

.pull-right-66[
Из исходных данных получают матрицу ковариаций:


``` r
# X_cov &lt;- cov(X)
X_cov &lt;- t(X_cent) %*% X_cent/(nrow(X_cent) - 1)
X_cov
```

```
       x1    x2
x1 63.485 8.057
x2  8.057 3.800
```

&gt; ### Матрица ковариаций

1. описывает совместное варьирование нескольких переменных;
1. по диагонали --- дисперсии признаков;
1. выше и ниже диагонали --- ковариации признаков друг с другом.
]

---

## Матрицу ковариаций можно представить в виде собственных векторов и собственных чисел


Матрица ковариаций


```
       x1    x2
x1 63.485 8.057
x2  8.057 3.800
```

.pull-left[
#### Собственные числа

- используются для оценки вклада главных компонент в общую изменчивость
- дисперсия вдоль собственных векторов пропорциональна их собственным числам


```
[1] 64.553  2.732
```
]

.pull-right[
#### Собственные векторы
- их столько же, сколько исходных переменных
- перпендикулярны друг другу
- задают направление осей главных компонент
- вдоль первого --- максимальная дисперсия данных, вдоль следующего --- максимальная дисперсия из оставшейся и т.д.


```
        [,1]    [,2]
[1,] -0.9913  0.1315
[2,] -0.1315 -0.9913
```
]

---

## Новые оси в многомерном пространстве

С помощью собственных векторов и собственных чисел можно найти в пространстве признаков новые оси, вдоль которых будет максимальный разброс точек.


![](07_pca_files/figure-html/future-ax-1.png)&lt;!-- --&gt;


---

## Координаты точек в новом пространстве

![](07_pca_files/figure-html/unnamed-chunk-11-1.png)&lt;!-- --&gt;

![](07_pca_files/figure-html/unnamed-chunk-12-1.png)&lt;!-- --&gt;

---

## График ординации

На графике ординации изображено новое пространство

&lt;img src="07_pca_files/figure-html/unnamed-chunk-13-1.png" style="display: block; margin: auto;" /&gt;

.pull-left[
По собственным числам судим о доле изменчивости, объясненной новыми направлениями осей (компонентами):

- PC1 --- больше всего изменчивости;
- PC2 --- то, что осталось.
]

.pull-right[
По новым координатам судим о близости объектов.

По факторным нагрузкам исходных переменных на компоненты интерпретируем новые направления.
]

---

class: middle, center, inverse

# Анализ главных компонент в R

---

## Пример: измерения ирисов 

.pull-left[
![](images/Irissetosa1.jpg)
.tiny[
из Wikimedia
]
]

.pull-right[
Будем тренироваться на классическом датасете, в котором содержатся данные об измерении разных частей ирисов разных видов. 

- Sepal.Length --- длина чашелистника;
- Sepal.Width --- ширина чашелистника;
- Petal.Length --- длина лепестка;
- Petal.Width --- ширина лепестка;
- Species --- вид ириса. 
]

---

## Знакомимся с данными


``` r
data(iris)
colnames(iris)
```

```
[1] "Sepal.Length" "Sepal.Width"  "Petal.Length" "Petal.Width"  "Species"     
```

``` r
colnames(iris) &lt;- c("s_len", "s_wid", "p_len", "p_wid", "Sp") # переименовываем столбцы

colSums(is.na(iris))
```

```
s_len s_wid p_len p_wid    Sp 
    0     0     0     0     0 
```

---

## Знакомимися с данными


``` r
# количество ирисов разных видов
table(iris$Sp)
```

```

    setosa versicolor  virginica 
        50         50         50 
```

---

## Как связаны признаки между собой?

Можно построить серию графиков с признаками во всех возможных комбинациях.

.pull-left[

``` r
# сколько всего видов
n_species &lt;- length(unique(iris$Sp))
# цвета из Брюеровской палитры 'Dark2'
library(RColorBrewer)
cols &lt;- brewer.pal(n = n_species, name = 'Dark2')
# график измерений
pairs(iris[, 1:4], col = cols[iris$Sp])
```
]

.pull-right[
![](07_pca_files/figure-html/pairs-iris-1.png)&lt;!-- --&gt;
]

---

## Анализ главных компонент


``` r
library(vegan)
# ординация, используем исключительно измерения 
ord_iris &lt;- rda(iris[, 1:4], scale = TRUE)
```

.small[

``` r
summary(ord_iris)
```

```

Call:
rda(X = iris[, 1:4], scale = TRUE) 

Partitioning of correlations:
              Inertia Proportion
Total               4          1
Unconstrained       4          1

Eigenvalues, and their contribution to the correlations 

Importance of components:
                       PC1   PC2    PC3     PC4
Eigenvalue            2.92 0.914 0.1468 0.02071
Proportion Explained  0.73 0.229 0.0367 0.00518
Cumulative Proportion 0.73 0.958 0.9948 1.00000
```
]

---

## Части результатов в `summary()`

- Importance of components --- __собственные числа__ (eigenvalues) и доля объясненной изменчивости.
- Species scores --- __факторные нагрузки исходных переменных__ на каждую из компонент.
- Site scores --- __факторные координаты объектов__.

### Масштабирование --- scaling

- __scaling = "species", correlation = TRUE__ --- отношения между переменными (нагрузки переменных пересчитаны с учетом собственных чисел, интерпретируются как корреляции).
- __scaling = "sites"__ --- отношения между объектами (факторные координаты пересчитаны с учетом соб. чисел).

---

## Что нужно знать, чтобы интерпретировать результаты?

Мы хотим снизить размерность данных и вместо множества исходных признаков получить несколько главных компонент (лучше 2 или 3 для удобства интерпретации).

Эти главные компоненты будут описывать данные почти так же хорошо, как исходные признаки, но при этом будут независимы друг от друга.

Мы сможем трактовать компоненты как сложные признаки и описывать отношения между объектами в терминах этих признаков.

Чтобы все это получилось, нужно ответить на несколько вопросов:

1. Сколько компонент нужно оставить?
2. Сколько общей изменчивости объясняют оставленные компоненты?
3. Что означают получившиеся компоненты?
4. Как располагаются объекты в пространстве главных компонент?

---

## 1. Cколько компонент нужно оставить?

Можно оставить только компоненты, которые объясняют больше изменчивости, чем возможно случайно (по модели сломанной палки), либо только компоненты, которые объясняют суммарно заданный процент общей изменчивости.

Строим график собственных чисел. 


``` r
screeplot(ord_iris, bstick = TRUE, type = 'lines')
```

![](07_pca_files/figure-html/unnamed-chunk-17-1.png)&lt;!-- --&gt;

---

## 2. Сколько изменчивости объясняют компоненты?

Изменчивость, объясненная каждой из компонент, в процентах:


``` r
eigenvals(ord_iris) / sum(eigenvals(ord_iris)) * 100
```

```
  PC1   PC2   PC3   PC4 
72.96 22.85  3.67  0.52 
```

Первые две компоненты объясняют 96 % общей изменчивости. Поэтому оставим обе, чтобы компоненты объясняли более 90%. 

---

## 3. Что означают получившиеся компоненты?

Факторные нагрузки описывают связь переменных с компонентами

- Вклад переменных в изменчивость вдоль компоненты тем сильнее, чем больше модуль их факторной нагрузки.
- Знак факторной нагрузки означает направление изменения исходной переменной вдоль главной компоненты.

.small[

``` r
scores(ord_iris, display = 'species', choices = c(1, 2),
       scaling = 'species', correlation = TRUE)
```

```
          PC1       PC2
s_len  0.3603 -0.146057
s_wid -0.1863 -0.357305
p_len  0.4014 -0.009478
p_wid  0.3906 -0.025906
attr(,"const")
[1] 4.941
```
]

---

## 3. Что означают получившиеся компоненты?

 | PC1 | PC2 
- | ---- | ---- 
s_len | **0.3603** | -0.146057
s_wid | -0.1863 | **-0.357305**
p_len | **0.4014** | -0.009478
p_wid | **0.3906** | -0.025906

- PC1 --- почти все измерения ирисов. Высокие измерения у 3 из 4 измерений: длина чашелистника, длина лепестка и ширина лепестка. Нагрузки с положительным знаком, значит, у больших ирисов будут большие значения по первой компоненте.
- PC2 --- ширина чашелистника. Отрицательный знак, значит, у больших ирисов будут небольшие значения по второй компоненте. 

---


## Можно нарисовать факторные нагрузки на графике

- Чем ближе стрелки исходных признаков к оси компоненты, тем выше их нагрузка.
- Стрелки направлены в сторону увеличения значения исходного признака


``` r
biplot(ord_iris, scaling = 'species', correlation = TRUE, 
       main = 'PCA -  species scaling', display = 'species')
```

![](07_pca_files/figure-html/unnamed-chunk-20-1.png)&lt;!-- --&gt;


---

## График факторных нагрузок в ggplot2


``` r
library(ggplot2)
theme_set(theme_bw())
library(ggrepel) # для подписей (geom_text_repel)
library(grid) # для стрелочек
# параметры стрелочек
ar &lt;- arrow(length = unit(0.1, 'cm'))
# датафрейм с факторными нагрузками
df_load_iris &lt;- data.frame(scores(ord_iris, display = 'species',
         choices = c(1, 2), scaling = 'species', correlation = TRUE))
# график
ggloadings &lt;- ggplot(df_load_iris) + 
  geom_text_repel(aes(x = PC1, y = PC2,
    label = rownames(df_load_iris)), segment.alpha = 0.5, size = 3) + 
  geom_segment(aes(x = 0, y = 0, xend = PC1, yend = PC2), 
    colour = 'grey40', arrow = ar) + 
  coord_equal(xlim = c(-0.8, 0.8), ylim = c(-0.8, 0.8))
ggloadings
```

---

## График факторных нагрузок в ggplot2

&lt;img src="07_pca_files/figure-html/ggload-iris-1.png" width="60%" /&gt;

---

## Интерпретируем компоненты по графику факторных нагрузок

.pull-left[
- PC1 --- почти все измерения ирисов. Высокие измерения у 3 из 4 измерений: длина чашелистника, длина лепестка и ширина лепестка. Нагрузки с положительным знаком, значит, у больших ирисов будут большие значения по первой компоненте.
- PC2 --- ширина чашелистника. Отрицательный знак, значит, у больших ирисов будут небольшие значения по второй компоненте. 
]

.pull-right[
![](07_pca_files/figure-html/ggload-pos-1.png)&lt;!-- --&gt;
]

---

## 4. Значения факторов (= факторные координаты) --- координаты объектов в пространстве главных компонент

.small[

``` r
# Координаты можно добыть так (но сейчас нам нужен только график)
scores(ord_iris, display = 'sites',  choices = c(1, 2), scaling = 'sites')
```

```
             PC1       PC2
sit1   -0.456822 -0.096828
sit2   -0.419759  0.135982
sit3   -0.476898  0.068968
sit4   -0.463818  0.120503
sit5   -0.482065 -0.130476
sit6   -0.418684 -0.300388
sit7   -0.492995 -0.009610
sit8   -0.450396 -0.045012
sit9   -0.470930  0.224977
sit10  -0.440609  0.094607
sit11  -0.436975 -0.210527
sit12  -0.469213 -0.026844
sit13  -0.447492  0.146984
sit14  -0.531133  0.193949
sit15  -0.443517 -0.375199
sit16  -0.456320 -0.541861
sit17  -0.445301 -0.299265
sit18  -0.441824 -0.098606
sit19  -0.382968 -0.283412
sit20  -0.472690 -0.227503
sit21  -0.386146 -0.082472
sit22  -0.445185 -0.186408
sit23  -0.559624 -0.092454
sit24  -0.366851 -0.017258
sit25  -0.449250 -0.027686
sit26  -0.393715  0.126196
sit27  -0.413746 -0.048848
sit28  -0.437432 -0.106333
sit29  -0.431580 -0.063180
sit30  -0.456935  0.068125
sit31  -0.431692  0.101773
sit32  -0.369458 -0.085465
sit33  -0.527471 -0.361789
sit34  -0.493428 -0.433832
sit35  -0.425611  0.092829
sit36  -0.445346  0.041575
sit37  -0.412535 -0.133446
sit38  -0.509798 -0.119474
sit39  -0.490091  0.182386
sit40  -0.437661 -0.054237
sit41  -0.461214 -0.089100
sit42  -0.374809  0.471489
sit43  -0.515104  0.096641
sit44  -0.396257 -0.095275
sit45  -0.431075 -0.230404
sit46  -0.417496  0.143429
sit47  -0.481034 -0.226006
sit48  -0.482979  0.077911
sit49  -0.449710 -0.201302
sit50  -0.444544 -0.001859
sit51   0.222245 -0.174074
sit52   0.147521 -0.119942
sit53   0.250323 -0.124316
sit54   0.082195  0.353888
sit55   0.216938  0.042041
sit56   0.078404  0.119674
sit57   0.150585 -0.155929
sit58  -0.098300  0.373661
sit59   0.187171 -0.006500
sit60   0.002305  0.208576
sit61  -0.022228  0.535364
sit62   0.088894  0.012768
sit63   0.113385  0.355970
sit64   0.145146  0.037564
sit65  -0.006728  0.088553
sit66   0.176582 -0.102685
sit67   0.070651  0.039599
sit68   0.032034  0.159777
sit69   0.247118  0.327229
sit70   0.033266  0.262754
sit71   0.148801 -0.079994
sit72   0.096074  0.084179
sit73   0.248951  0.188265
sit74   0.127656  0.083991
sit75   0.141737  0.012791
sit76   0.176353 -0.050589
sit77   0.253455  0.015584
sit78   0.274009 -0.066830
sit79   0.134100  0.045573
sit80  -0.008121  0.213558
sit81   0.026383  0.315132
sit82   0.004731  0.317190
sit83   0.048722  0.156783
sit84   0.214038  0.127855
sit85   0.045180  0.058048
sit86   0.086563 -0.170566
sit87   0.211543 -0.105305
sit88   0.210697  0.278968
sit89   0.014037  0.044277
sit90   0.057181  0.268143
sit91   0.056294  0.225925
sit92   0.125984 -0.005027
sit93   0.067883  0.199375
sit94  -0.073057  0.407308
sit95   0.058212  0.172613
sit96   0.018429  0.036549
sit97   0.045934  0.077644
sit98   0.116266  0.031240
sit99  -0.090301  0.311404
sit100  0.051786  0.120797
sit101  0.372075 -0.175576
sit102  0.233561  0.140972
sit103  0.444833 -0.113365
sit104  0.290498  0.009478
sit105  0.376764 -0.059515
sit106  0.555091 -0.161454
sit107  0.074033  0.314977
sit108  0.464434 -0.084733
sit109  0.404777  0.143507
sit110  0.455829 -0.387495
sit111  0.275173 -0.139739
sit112  0.323283  0.085063
sit113  0.380009 -0.084569
sit114  0.254183  0.234444
sit115  0.296045  0.089212
sit116  0.320741 -0.136408
sit117  0.296808 -0.051562
sit118  0.489424 -0.515714
sit119  0.667813 -0.003587
sit120  0.254919  0.344274
sit121  0.411036 -0.183654
sit122  0.197272  0.115333
sit123  0.584497 -0.083437
sit124  0.268932  0.097188
sit125  0.343062 -0.204522
sit126  0.394215 -0.203283
sit127  0.237035  0.063821
sit128  0.205940 -0.012979
sit129  0.360735  0.037793
sit130  0.375924 -0.113422
sit131  0.491366 -0.052301
sit132  0.464936 -0.529766
sit133  0.375733  0.036016
sit134  0.224739  0.059087
sit135  0.242556  0.163654
sit136  0.564551 -0.172829
sit137  0.317953 -0.215548
sit138  0.271566 -0.085210
sit139  0.186550 -0.003474
sit140  0.373583 -0.136384
sit141  0.406415 -0.123829
sit142  0.383616 -0.139097
sit143  0.233561  0.140972
sit144  0.411609 -0.174991
sit145  0.403054 -0.211632
sit146  0.377307 -0.078056
sit147  0.315598  0.180874
sit148  0.306841 -0.054275
sit149  0.276910 -0.203984
sit150  0.193778  0.004908
attr(,"const")
[1] 4.941
```
]

---

## График факторных координат (= график ординации)


``` r
biplot(ord_iris, scaling = 'sites', display = 'sites', 
       type = 't', main = 'PCA - sites scaling')
```

&lt;img src="07_pca_files/figure-html/unnamed-chunk-22-1.png" style="display: block; margin: auto;" /&gt;

---

## График факторных координат в ggplot2


``` r
# данные для графика: факторные координаты и исходные переменные
df_scores_iris &lt;- data.frame(iris, 
                        scores(ord_iris, display = 'sites', scaling = 'sites', 
                               choices = c(1, 2)))
# график ординации
ggscores &lt;- ggplot(df_scores_iris, aes(x = PC1, y = PC2, 
                                  colour = Sp)) + 
  geom_point(size = 2) + coord_equal()
ggscores
```

&lt;img src="07_pca_files/figure-html/ggscor-iris-1.png" style="display: block; margin: auto;" /&gt;

---

## Для удобства интерпретации ординации, располагаем ее рядом с графиком факторных нагрузок

.pull-left[


``` r
library(cowplot)
plot_grid(ggloadings, ggscores, labels = 'AUTO')
```

![](07_pca_files/figure-html/unnamed-chunk-23-1.png)&lt;!-- --&gt;
]

.pull-right[
Или отобразить одновременно на графике...
![](07_pca_files/figure-html/load_scores_iris-1.png)&lt;!-- --&gt;
]


---

## Отображение нагрузок и координат одновременно на графике

.pull-left[

``` r
ggplot(df_load_iris) + 
  geom_point(df_scores_iris, mapping = aes(x = PC1, y = PC2, colour = Sp), size = 2) + 
  geom_segment(aes(x = 0, y = 0, xend = PC1, yend = PC2), 
    colour = 'grey40', arrow = ar) + 
  coord_equal(xlim = c(-0.8, 0.8), ylim = c(-0.8, 0.8)) +
  geom_text_repel(aes(x = PC1, y = PC2,
    label = rownames(df_load_iris)), size = 3) + coord_equal()
```

![](07_pca_files/figure-html/load_scores_iris-1.png)&lt;!-- --&gt;
]

.pull-right[
Первые две компоненты объясняют почти 96% общей изменчивости. Первая компонента (73%) связана с длиной чашелистника, длиной и шириной лепестка. Вторая компонента (23%) описывает ширину чашелистника. Внутри видов ирисы различаются по ширине чашелистника (об этом говорит разброс точек вдоль второй компоненты). Ирисы вида setosa не похожи versicolor и virginica: у них относительно более короткие чашелистник и лепестки, и более узкие лепестки.
]

---

## Факторные координаты можно использовать для снижения размерности данных

Было 7 скоррелированных признаков, стало 2 __независимых__ (они ведь перпендикулярны) главных компоненты.

Значения факторных координат можно использовать в анализах, где нужна независимость переменных:

- Множественная регрессия;
- Дискриминантный анализ (например, генетические данные);
- Дисперсионный анализ;
- Корреляция с другими признаками, которые не были использованы в анализе главных компонент, и т.д., и т.п.

---

## Условия применимости анализа главных компонент

Похожи на условия применимости множественной линейной регрессии.

--

- Линейные связи между переменными (т.к. матрица корреляций или ковариаций);
- Исключить наблюдения, в которых есть пропущенные значения;
- Если много нулей --- трансформация данных (например, трансформация Хелингера);
- Если очень много нулей --- удалить такие переменные из анализа.

---

## Пример: Морфометрия поссумов

.pull-left[

![](images/possum.jpg)

.tiny[
pos by Hasitha Tudugalle on [Flickr](https://www.flickr.com/photos/hasitha\_tudugalle/6037880962)
]
]

.pull-right[

В датафрейме содержатся данные об измерениях поссумов в разных частях тела. Кроме того, есть ещё и факторные переменные: 

- site --- места, в которых поссумы были пойманы (7 локаций);

- Pop --- популяция, к которой поссумы относятся (`Victoria` или `other`);

- sex --- пол поссума (`f` или `m`).

.tiny[
Данные Lindenmayer et al. (1995)
]
]

---

## Знакомимся с данными


``` r
library(DAAG)
data(possum)
colnames(possum)
```

```
 [1] "case"     "site"     "Pop"      "sex"      "age"      "hdlngth"  "skullw"  
 [8] "totlngth" "taill"    "footlgth" "earconch" "eye"      "chest"    "belly"   
```

``` r
colSums(is.na(possum))
```

```
    case     site      Pop      sex      age  hdlngth   skullw totlngth    taill 
       0        0        0        0        2        0        0        0        0 
footlgth earconch      eye    chest    belly 
       1        0        0        0        0 
```

``` r
# оставим только строки с полными наблюдениями
pos &lt;- possum[complete.cases(possum), ]
```

---

## Знакомимися с данными


``` r
# поссумы из разных сайтов из 2 популяций
table(pos$site, pos$Pop)
```

```
   
    Vic other
  1  33     0
  2  10     0
  3   0     7
  4   0     7
  5   0    13
  6   0    13
  7   0    18
```

---

## Знакомимся с данными


``` r
# половой состав выборок из разных сайтов
table(pos$sex, pos$site, pos$Pop)
```

```
, ,  = Vic

   
     1  2  3  4  5  6  7
  f 19  4  0  0  0  0  0
  m 14  6  0  0  0  0  0

, ,  = other

   
     1  2  3  4  5  6  7
  f  0  0  3  2  6  4  4
  m  0  0  4  5  7  9 14
```

---

## Как связаны признаки между собой?

Можно построить серию графиков с признаками во всех возможных комбинациях.

.pull-left[

``` r
# сколько всего сайтов
n_sites &lt;- length(unique(pos$site))
# цвета из Брюеровской палитры 'Set1'
library(RColorBrewer)
cols &lt;- brewer.pal(n = n_sites, name = 'Set1')
# график морфометрических переменных
pairs(pos[, 6:14], col = cols[pos$site], 
      pch =  as.numeric(pos$sex))
```
]

.pull-right[
![](07_pca_files/figure-html/pairs-pos-1.png)&lt;!-- --&gt;
]

---

## Анализ главных компонент


``` r
library(vegan)
# ординация, используем морфометрические переменные (с hdlngth по belly)
ord_pos &lt;- rda(pos[, 6:14], scale = TRUE)
```

.small[

``` r
summary(ord_pos)
```

```

Call:
rda(X = pos[, 6:14], scale = TRUE) 

Partitioning of correlations:
              Inertia Proportion
Total               9          1
Unconstrained       9          1

Eigenvalues, and their contribution to the correlations 

Importance of components:
                        PC1   PC2   PC3    PC4    PC5    PC6    PC7    PC8   PC9
Eigenvalue            3.931 1.949 0.908 0.7516 0.5769 0.3099 0.2671 0.1625 0.144
Proportion Explained  0.437 0.217 0.101 0.0835 0.0641 0.0344 0.0297 0.0181 0.016
Cumulative Proportion 0.437 0.653 0.754 0.8378 0.9019 0.9363 0.9660 0.9840 1.000
```
]

---

## 1. Cколько компонент нужно оставить?

График собственных чисел.


``` r
screeplot(ord_pos, bstick = TRUE, type = 'lines')
```

![](07_pca_files/figure-html/unnamed-chunk-28-1.png)&lt;!-- --&gt;

---

## 2. Сколько изменчивости объясняют компоненты?

Посмотрев на broken stick model, решили оставить 2 компоненты. Смотрим, сколько же изменчивости они объясняют.


``` r
eigenvals(ord_pos) / sum(eigenvals(ord_pos)) * 100
```

```
  PC1   PC2   PC3   PC4   PC5   PC6   PC7   PC8   PC9 
43.68 21.65 10.09  8.35  6.41  3.44  2.97  1.81  1.60 
```

Первые две компоненты объясняют 65 % общей изменчивости.

---

## 3. Факторные нагрузки

.small[

``` r
scores(ord_pos, display = 'species', choices = c(1, 2, 3),
       scaling = 'species', correlation = TRUE)
```

```
             PC1      PC2       PC3
hdlngth  -0.4714 -0.04838  0.078656
skullw   -0.4194 -0.08481  0.131206
totlngth -0.4542 -0.05970 -0.177802
taill    -0.2098 -0.36809 -0.279173
footlgth -0.3334  0.38004 -0.041290
earconch -0.1505  0.48821 -0.011420
eye      -0.2017 -0.21131  0.370315
chest    -0.4447  0.06787 -0.005893
belly    -0.3984 -0.06277 -0.023506
attr(,"const")
[1] 5.477
```
]

- PC1 --- это физические размеры поссумов (высокие нагрузки у переменных длина головы, общая длина, измерения черепа, груди и живота). У нагрузок отрицательный знак, значит у крупных поссумов будут маленькие значения координат по первой компоненте.
- PC2 --- длина ушей, ног и хвоста. Высокие значения по этой компоненте у поссумов с большими ушами, длинными ногами и коротким хвостом.
- PC3 --- размеры глаз. Высокие значения по этой компоненте будут у поссумов с большими глазами.

---

## Можно нарисовать факторные нагрузки на графике

- Чем ближе стрелки исходных признаков к оси компоненты, тем выше их нагрузка.
- Стрелки направлены в сторону увеличения значения исходного признака


``` r
biplot(ord_pos, scaling = 'species', correlation = TRUE, 
       main = 'PCA -  species scaling', display = 'species')
```

![](07_pca_files/figure-html/unnamed-chunk-31-1.png)&lt;!-- --&gt;


---

## График факторных нагрузок в ggplot2


``` r
library(ggplot2)
theme_set(theme_bw())
library(ggrepel) # для подписей (geom_text_repel)
library(grid) # для стрелочек
# параметры стрелочек
ar &lt;- arrow(length = unit(0.1, 'cm'))
# датафрейм с факторными нагрузками
df_load_pos &lt;- data.frame(scores(ord_pos, display = 'species',
         choices = c(1, 2), scaling = 'species', correlation = TRUE))
# график
ggloadings &lt;- ggplot(df_load_pos) + 
  geom_text_repel(aes(x = PC1, y = PC2,
    label = rownames(df_load_pos)), segment.alpha = 0.5, size = 3) + 
  geom_segment(aes(x = 0, y = 0, xend = PC1, yend = PC2), 
    colour = 'grey40', arrow = ar) + 
  coord_equal(xlim = c(-0.8, 0.8), ylim = c(-0.8, 0.8))
ggloadings
```

---

## График факторных нагрузок в ggplot2

&lt;img src="07_pca_files/figure-html/ggload-pos-1.png" width="60%" /&gt;

---

## Интерпретируем компоненты по графику факторных нагрузок

.pull-left[
- PC1 --- это физические размеры поссумов (высокие нагрузки у переменных длина головы, общая длина, измерения черепа, груди и живота). У нагрузок отрицательный знак, значит у крупных поссумов будут маленькие значения координат по первой компоненте.
- PC2 --- длина ушей, ног и хвоста. Высокие значения по этой компоненте у поссумов с большими ушами, длинными ногами и коротким хвостом.
]

.pull-right[
![](07_pca_files/figure-html/ggload-pos-1.png)&lt;!-- --&gt;
]

---

## 4. Значения факторов (= факторные координаты) --- координаты объектов в пространстве главных компонент

.small[

``` r
# Координаты можно добыть так (но сейчас нам нужен только график)
scores(ord_pos, display = 'sites',  choices = c(1, 2, 3), scaling = 'sites')
```

```
            PC1       PC2       PC3
C3    -0.360819  0.304131  0.068882
C5    -0.240088  0.143367  0.069353
C10   -0.551140  0.107837 -0.142387
C15   -0.312800  0.207126 -0.127399
C23   -0.034486  0.267285  0.048805
C24   -0.151005  0.394274 -0.126411
C26   -0.298397  0.251334 -0.069267
C27   -0.306099  0.266872 -0.120363
C28   -0.214566  0.193184 -0.029604
C31   -0.095501  0.209273 -0.138730
C32   -0.399460  0.205195 -0.180091
C34   -0.187569  0.198586  0.018334
C36   -0.191356  0.080859  0.164452
C37   -0.250735  0.312059  0.003360
C39   -0.084378  0.232837  0.251536
C40    0.039106  0.358378  0.025134
C45   -0.431886  0.225797  0.107782
C47   -0.159125  0.359987  0.005883
C48   -0.147426  0.357401  0.040818
C50   -0.269824  0.142425 -0.043247
C54   -0.721545  0.197425 -0.381501
C55   -0.470570  0.009351 -0.017002
C58   -0.179847  0.264002  0.027001
C59   -0.012764  0.393053  0.297774
C60   -0.423283  0.240103  0.015092
C61   -0.468845  0.340503  0.017970
C63    0.434840  0.271552 -0.013482
C64   -0.002056  0.352661  0.154275
A1     0.100915  0.362892 -0.071345
A2     0.254432  0.313644  0.105768
A3    -0.001846  0.153094 -0.189561
A4    -0.355399  0.136578 -0.236122
AD1    0.185835  0.172623 -0.099539
BB4    0.189828  0.330216 -0.068164
BB13  -0.219516  0.261749  0.276412
BB15  -0.161504  0.280269  0.079658
BB17   0.229941  0.384455 -0.074561
BB25   0.211584  0.112188  0.270842
BB31   0.875720  0.520198 -0.042632
BB33   0.190072  0.342089 -0.136572
BB38   0.651861  0.319004  0.164967
BB40   0.266959  0.478522  0.088011
BB44   0.207286  0.430262  0.144811
WW1    0.184773 -0.144287 -0.095196
WW2   -0.294015 -0.138382  0.561323
WW3   -0.244531 -0.127742  0.184002
WW4   -0.055454 -0.137956 -0.092484
WW5   -0.236102 -0.320836  0.434444
WW6   -0.411132 -0.338812 -0.044569
WW7   -0.121341 -0.227839  0.098582
BR1   -0.720027 -0.448771  0.042208
BR2   -0.772324 -0.198649  0.190001
BR3   -0.425563 -0.204040  0.149246
BR4   -0.535037 -0.302426 -0.309767
BR5   -0.387389 -0.184917 -0.107222
BR6   -0.856619 -0.199148 -0.182914
BR7    0.166566 -0.194086 -0.159757
CD1    0.043023 -0.256022  0.044971
CD2   -0.018057 -0.398079 -0.005911
CD3    0.210501 -0.178453 -0.031079
CD4   -0.079171 -0.393242  0.192795
CD5   -0.205986 -0.207358 -0.193970
CD6    0.168957 -0.218758  0.107447
CD7    0.110374 -0.214042  0.277164
CD8    0.006584 -0.338677  0.239780
CD9   -0.135090 -0.167162 -0.010195
CD10   0.117183 -0.122796 -0.298981
CD11  -0.098997 -0.355409 -0.173221
CD12   0.687399 -0.082374  0.000783
CD13   0.713032 -0.096019  0.102362
BSF1   0.382885 -0.187544 -0.109816
BSF2  -0.095796 -0.278569  0.186945
BSF3  -0.088338 -0.451364  0.124600
BSF4   0.161236 -0.289700  0.255049
BSF5   0.815656 -0.034823 -0.203592
BSF6   0.838254 -0.154467 -0.026663
BSF7   0.561603 -0.218543 -0.083130
BSF8   0.024080 -0.367761  0.194712
BSF9   0.498804 -0.246429  0.084989
BSF10  0.567804 -0.120857 -0.020391
BSF11  0.532966 -0.203359  0.274382
BSF12  0.054610 -0.312919 -0.327608
BSF13  0.432085 -0.246840 -0.292040
BTP1  -0.473977 -0.256216 -0.229606
BTP3   0.131528 -0.259170  0.071717
BTP4   0.006979 -0.004383  0.142541
BTP5   0.153808 -0.093555 -0.140779
BTP6  -0.128345 -0.148171  0.012405
BTP7   0.237104 -0.011113 -0.046458
BTP8   0.529899 -0.089257 -0.289417
BTP9   0.057095 -0.060806  0.055405
BTP10  0.117172 -0.161179 -0.052678
BTP12  0.170674 -0.046389 -0.107138
BTP13  0.326451 -0.147052 -0.143554
BTP14 -0.139327 -0.101384  0.271792
BTP15  0.006261 -0.212769 -0.187780
BTP16  0.544986 -0.016307  0.072887
BTP17  0.349041 -0.096955 -0.205936
BTP19  0.289579 -0.117897 -0.326378
BTP20  0.402589 -0.134179  0.138239
BTP21 -0.213468 -0.218403 -0.151478
attr(,"const")
[1] 5.477
```
]

---

## График факторных координат (= график ординации)


``` r
biplot(ord_pos, scaling = 'sites', display = 'sites', 
       type = 't', main = 'PCA - sites scaling')
```

&lt;img src="07_pca_files/figure-html/unnamed-chunk-33-1.png" style="display: block; margin: auto;" /&gt;

---

## График факторных координат в ggplot2


``` r
# данные для графика: факторные координаты и исходные переменные
df_scores_pos &lt;- data.frame(pos, 
                        scores(ord_pos, display = 'sites', scaling = 'sites', 
                               choices = c(1, 2)))
# график ординации
ggscores &lt;- ggplot(df_scores_pos, aes(x = PC1, y = PC2, 
                                  colour = Pop, shape = sex)) + 
  geom_point(size = 2) + coord_equal()
ggscores
```

&lt;img src="07_pca_files/figure-html/ggscor-pos-1.png" style="display: block; margin: auto;" /&gt;

---

## Для удобства интерпретации ординации, располагаем ее рядом с графиком факторных нагрузок

.pull-left[


``` r
library(cowplot)
plot_grid(ggloadings, ggscores, labels = 'AUTO')
```

![](07_pca_files/figure-html/unnamed-chunk-34-1.png)&lt;!-- --&gt;
]
--

.pull-right[
Первые две компоненты объясняют 65% общей изменчивости. Первая компонента (44%) связана с размером особей. Вторая компонента (21%) описывает пропорции ног, ушей и хвоста. Внутри популяций поссумы мало различаются по этим параметрам (об этом говорит небольшой разброс точек вдоль второй компоненты). Зато поссумы из провинции Виктория не похожи на поссумов из других провинций: у них относительно более крупные уши, длинные ноги и короткие хвосты.
]

---

## Take-home messages

- Метод главных компонент:
    - исследование связей между переменными;
    - построение ординации объектов;
    - снижение размерности данных.
- Собственные числа --- вклад компонент в общую изменчивость.
- Факторные нагрузки --- связь исходных переменных с компонентами --- используются для интерпретации.
- Значения факторов (факторные координаты) --- новые координаты объектов в пространстве уменьшенной размерности.
- Значения факторов можно использовать как новые комплексные переменные в других видах анализов.

---

## Дополнительные ресурсы

- Borcard, D., Gillet, F., Legendre, P., 2011. Numerical ecology with R. Springer.
- Legendre, P., Legendre, L., 2012. Numerical ecology. Elsevier.
- Oksanen, J., 2011. Multivariate analysis of ecological communities in R: vegan tutorial. R package version 2–0.
- The Ordination Web Page URL http://ordination.okstate.edu/ (accessed 10.21.13).
- Quinn, G.G.P., Keough, M.J., 2002. Experimental design and data analysis for biologists. Cambridge University Press.
- Zuur, A.F., Ieno, E.N., Smith, G.M., 2007. Analysing ecological data. Springer.

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="assets/macros.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "vs",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>
<!-- https://github.com/fnaufel/xaringan-smartify-->
<script type="text/javascript">
  smartify();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
