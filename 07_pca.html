<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Анализ главных компонент</title>
    <meta charset="utf-8" />
    <meta name="author" content="Марина Варфоломеева" />
    <meta name="author" content="Анастасия Лянгузова" />
    <script src="libs/header-attrs-2.25/header-attrs.js"></script>
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/tamu-fonts.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/ninjutsu.css" rel="stylesheet" />
    <link href="libs/tile-view-0.2.6/tile-view.css" rel="stylesheet" />
    <script src="libs/tile-view-0.2.6/tile-view.js"></script>
    <script src="libs/fabric-4.3.1/fabric.min.js"></script>
    <link href="libs/xaringanExtra-scribble-0.0.1/scribble.css" rel="stylesheet" />
    <script src="libs/xaringanExtra-scribble-0.0.1/scribble.js"></script>
    <script>document.addEventListener('DOMContentLoaded', function() { window.xeScribble = new Scribble({"pen_color":["#FF0000"],"pen_size":3,"eraser_size":30,"palette":[]}) })</script>
    <script src="libs/mark.js-8.11.1/mark.min.js"></script>
    <link href="libs/xaringanExtra-search-0.0.1/search.css" rel="stylesheet" />
    <script src="libs/xaringanExtra-search-0.0.1/search.js"></script>
    <script>window.addEventListener('load', function() { window.xeSearch = new RemarkSearch({"position":"bottom-left","caseSensitive":false,"showIcon":false,"autoSearch":true}) })</script>
    <script src="libs/xaringanExtra-progressBar-0.0.1/progress-bar.js"></script>
    <script src="libs/freezeframe-5.0.2/freezeframe.min.js"></script>
    <script src="libs/xaringanExtra-freezeframe-0.0.1/freezeframe-init.js"></script>
    <script id="xaringanExtra-freezeframe-options" type="application/json">{"selector":"img[src$=\"gif\"]","trigger":"click","overlay":false,"responsive":true,"warnings":true}</script>
    <link href="libs/tachyons-4.12.0/tachyons.min.css" rel="stylesheet" />
    <!-- https://github.com/fnaufel/xaringan-smartify-->
    <script
    			  src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    			  integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8="
    			  crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/fnaufel/xaringan-smartify/smartify.min.js"></script>
    <link rel="stylesheet" href="assets/xaringan-themer.css" type="text/css" />
    <link rel="stylesheet" href="assets/xaringan.css" type="text/css" />
    <link rel="stylesheet" href="assets/scrollable.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: middle, left, inverse, title-slide

.title[
# Анализ главных компонент
]
.subtitle[
## Математические модели в зоологии
]
.author[
### Марина Варфоломеева
]
.author[
### Анастасия Лянгузова
]

---




class: middle, center, inverse

## Ординация на примере метода главных компонент

---

### Вы сможете

- Проводить анализ главных компонент
- Снижать размерность данных, отбирая меньшее число главных компонент
- Оценивать долю объясненной изменчивости
- Интерпретировать компоненты по значениям факторных нагрузок
- Строить ординацию объектов в пространстве главных компонент
- Извлекать значения факторов объектов для дальнейшего использования с другими видами анализов

---

class: middle, center, inverse

# Общая характеристика многомерных методов 

---

## Почему нужны многомерные методы?

Пусть у нас имеется две группы объектов, у которых мы изучили некий признак. Мы хотим тестировать гипотезу о том, что эти две группы различаются.  

Вспомним логику тестирования гипотез.

&lt;img src="07_pca_files/figure-html/unnamed-chunk-1-1.png" style="display: block; margin: auto;" /&gt;

---

## Почему нужны многомерные методы?

Теперь представим, что наш объект, по своей природе, не может быть описан только по одному признаку

- Сообщества (признаки --- виды)
- Форма тела (признаки --- размеры тех или иных частей)
- Социальная активность животного (признаки --- проявление того или иного паттерна)
- Общественное мнение (признаки --- ответы на разные вопросы анкет)
- Транскриптом (признаки --- транскрипты)

---

class: middle, center, inverse

# Снижение размерности многомерных данных: анализ главных компонент (PCA)

---

## Анализ главных компонент --- способ снижения размерности

.pull-left[
### Многомерные исходные данные


```
    x1   x2
1 21.1 21.3
2 21.8 19.8
3 22.4 19.2
4 26.7 21.9
5 27.2 24.7
6 27.4 25.3
```


![](07_pca_files/figure-html/unnamed-chunk-2-1.png)&lt;!-- --&gt;
]

.pull-right[
В этом примере для простоты используются двумерные данные, т.е. у каждого наблюдения (строки) есть два свойства (столбцы). Например, это могут быть свойства деревьев: x1 --- диаметр ствола, x2 --- высота ствола.
]

---

## Центрирование

&gt; ### Центрирование
&gt;
&gt; Из каждого значения переменной вычитают ее среднее значение.



.pull-left-33[
Центрированные данные:


```
        x1   x2
[1,] -12.6 -1.9
[2,] -11.9 -3.4
[3,] -11.3 -4.0
[4,]  -7.0 -1.3
[5,]  -6.5  1.5
[6,]  -6.3  2.1
```
]

.pull-right[

![](07_pca_files/figure-html/unnamed-chunk-5-1.png)&lt;!-- --&gt;
]

Если центрировать данные (вычесть среднее  x1  =  33.7, среднее  x2  =  23.2), то центр координат переместится в точку `\((\bar x _{1}, \bar x _{2})\)`

---

## Матрица ковариаций между признаками

.pull-left-33[

Исходные данные:


```
    x1   x2
1 21.1 21.3
2 21.8 19.8
3 22.4 19.2
4 26.7 21.9
5 27.2 24.7
6 27.4 25.3
```
]

.pull-right-66[
Из исходных данных получают матрицу ковариаций:


```r
# X_cov &lt;- cov(X)
X_cov &lt;- t(X_cent) %*% X_cent/(nrow(X_cent) - 1)
X_cov
```

```
       x1    x2
x1 63.485 8.057
x2  8.057 3.800
```

&gt; ### Матрица ковариаций

- описывает совместное варьирование нескольких переменных
- по диагонали --- дисперсии признаков
- выше и ниже диагонали --- ковариации признаков друг с другом
]

---

## Матрицу ковариаций можно представить в виде собственных векторов и собственных чисел


Матрица ковариаций


```
       x1    x2
x1 63.485 8.057
x2  8.057 3.800
```

.pull-left[
#### Собственные числа

- используются для оценки вклада главных компонент в общую изменчивость
- дисперсия вдоль собственных векторов пропорциональна их собственным числам


```
[1] 64.553  2.732
```
]

.pull-right[
#### Собственные векторы
- их столько же, сколько исходных переменных
- перпендикулярны друг другу
- задают направление осей главных компонент
- вдоль первого --- максимальная дисперсия данных, вдоль следующего --- максимальная дисперсия из оставшейся и т.д.


```
        [,1]    [,2]
[1,] -0.9913  0.1315
[2,] -0.1315 -0.9913
```
]

---

## Новые оси в многомерном пространстве

С помощью собственных векторов и собственных чисел можно найти в пространстве признаков новые оси, вдоль которых будет максимальный разброс точек.


![](07_pca_files/figure-html/future-ax-1.png)&lt;!-- --&gt;


---

## Координаты точек в новом пространстве

![](07_pca_files/figure-html/unnamed-chunk-11-1.png)&lt;!-- --&gt;

![](07_pca_files/figure-html/unnamed-chunk-12-1.png)&lt;!-- --&gt;

---

## График ординации

На графике ординации изображено новое пространство

&lt;img src="07_pca_files/figure-html/unnamed-chunk-13-1.png" style="display: block; margin: auto;" /&gt;

.pull-left[
По собственным числам судим о доле изменчивости, объясненной новыми направлениями осей (компонентами)

- PC1 --- больше всего изменчивости
- PC2 --- то, что осталось
]

.pull-right[
По новым координатам судим о близости объектов.

По факторным нагрузкам исходных переменных на компоненты интерпретируем новые направления.
]

---

class: middle, center, inverse

# Анализ главных компонент в R

---

## Пример: измерения ирисов 

.pull-left[
![](images/Irissetosa1.jpg)
.tiny[
из Wikimedia
]
]

.pull-right[
Будем тренироваться на классическом датасете, в котором содержатся данные об измерении разных частей ирисов разных видов. 

- Sepal.Length --- длина чашелистника;
- Sepal.Width --- ширина чашелистника;
- Petal.Length --- длина лепестка;
- Petal.Width --- ширина лепестка;
- Species --- вид ириса. 
]

---

## Знакомимся с данными


```r
data(iris)
colnames(iris)
```

```
[1] "Sepal.Length" "Sepal.Width"  "Petal.Length" "Petal.Width"  "Species"     
```

```r
colnames(iris) &lt;- c("s_len", "s_wid", "p_len", "p_wid", "Sp") # переименовываем столбцы

colSums(is.na(iris))
```

```
s_len s_wid p_len p_wid    Sp 
    0     0     0     0     0 
```

---

## Знакомимися с данными


```r
# количество ирисов разных видов
table(iris$Sp)
```

```

    setosa versicolor  virginica 
        50         50         50 
```

---

## Как связаны признаки между собой?

Можно построить серию графиков с признаками во всех возможных комбинациях.

.pull-left[

```r
# сколько всего видов
n_species &lt;- length(unique(iris$Sp))
# цвета из Брюеровской палитры 'Dark2'
library(RColorBrewer)
cols &lt;- brewer.pal(n = n_species, name = 'Dark2')
# график измерений
pairs(iris[, 1:4], col = cols[iris$Sp])
```
]

.pull-right[
![](07_pca_files/figure-html/pairs-iris-1.png)&lt;!-- --&gt;
]

---

## Анализ главных компонент


```r
library(vegan)
# ординация, используем исключительно измерения 
ord_iris &lt;- rda(iris[, 1:4], scale = TRUE)
```

.small[

```r
summary(ord_iris)
```

```

Call:
rda(X = iris[, 1:4], scale = TRUE) 

Partitioning of correlations:
              Inertia Proportion
Total               4          1
Unconstrained       4          1

Eigenvalues, and their contribution to the correlations 

Importance of components:
                       PC1   PC2    PC3     PC4
Eigenvalue            2.92 0.914 0.1468 0.02071
Proportion Explained  0.73 0.229 0.0367 0.00518
Cumulative Proportion 0.73 0.958 0.9948 1.00000

Scaling 2 for species and site scores
* Species are scaled proportional to eigenvalues
* Sites are unscaled: weighted dispersion equal on all dimensions
* General scaling constant of scores:  4.941 


Species scores

        PC1     PC2    PC3     PC4
s_len  2.20 -0.8914  0.681  0.0929
s_wid -1.14 -2.1807 -0.231 -0.0439
p_len  2.45 -0.0578 -0.135 -0.2850
p_wid  2.38 -0.1581 -0.600  0.1862


Site scores (weighted sums of species scores)

            PC1      PC2      PC3     PC4
sit1   -0.53481 -0.20256  0.13449  0.0677
sit2   -0.49142  0.28447  0.24706  0.2887
sit3   -0.55831  0.14428 -0.04655  0.0795
sit4   -0.54300  0.25208 -0.09614 -0.1849
sit5   -0.56436 -0.27295 -0.01657 -0.1007
sit6   -0.49016 -0.62839 -0.02840  0.0185
sit7   -0.57716 -0.02010 -0.35328 -0.1031
sit8   -0.52728 -0.09416  0.09340 -0.0690
sit9   -0.55132  0.47064 -0.15278 -0.0753
sit10  -0.51583  0.19791  0.26724 -0.1118
sit11  -0.51157 -0.44041  0.28295  0.0469
sit12  -0.54931 -0.05616 -0.09874 -0.3742
sit13  -0.52389  0.30748  0.24317  0.0068
sit14  -0.62180  0.40573 -0.19040 -0.0539
sit15  -0.51923 -0.78490  0.49801  0.5458
sit16  -0.53422 -1.13354 -0.03215  0.1416
sit17  -0.52132 -0.62604  0.00563  0.5293
sit18  -0.51725 -0.20628  0.04656  0.2609
sit19  -0.44835 -0.59288  0.39422  0.1713
sit20  -0.55338 -0.47592 -0.13967 -0.1058
sit21  -0.45207 -0.17253  0.44366  0.0306
sit22  -0.52118 -0.38996 -0.16835  0.1671
sit23  -0.65516 -0.19341 -0.34982  0.0551
sit24  -0.42948 -0.03610 -0.03632  0.4237
sit25  -0.52594 -0.05792 -0.12426 -0.7572
sit26  -0.46093  0.26399  0.32187  0.1221
sit27  -0.48438 -0.10219 -0.09095  0.1897
sit28  -0.51211 -0.22244  0.21780  0.0288
sit29  -0.50526 -0.13217  0.28555  0.2362
sit30  -0.53494  0.14251 -0.07207 -0.3035
sit31  -0.50539  0.21290  0.07899 -0.1351
sit32  -0.43253 -0.17879  0.28483  0.6724
sit33  -0.61752 -0.75684 -0.04974 -0.6426
sit34  -0.57766 -0.90755  0.08706 -0.1351
sit35  -0.49827  0.19419  0.17932  0.0814
sit36  -0.52137  0.08697  0.23741  0.4735
sit37  -0.48296 -0.27916  0.51026  0.5504
sit38  -0.59683 -0.24993 -0.02047 -0.3826
sit39  -0.57376  0.38154 -0.20352 -0.0273
sit40  -0.51238 -0.11346  0.18522  0.0198
sit41  -0.53995 -0.18639 -0.03675  0.2999
sit42  -0.43879  0.98633  0.21508  0.8125
sit43  -0.60304  0.20217 -0.32200 -0.1867
sit44  -0.46390 -0.19931 -0.32604  0.4964
sit45  -0.50466 -0.48199 -0.26162 -0.4234
sit46  -0.48877  0.30005  0.06732  0.3932
sit47  -0.56315 -0.47279 -0.06026 -0.4267
sit48  -0.56543  0.16299 -0.14687 -0.1369
sit49  -0.52648 -0.42111  0.19113 -0.0418
sit50  -0.52043 -0.00389  0.16115  0.1384
sit51   0.26018 -0.36415  0.72093  0.0976
sit52   0.17270 -0.25091  0.09912  0.0137
sit53   0.29306 -0.26006  0.58342  0.0264
sit54   0.09623  0.74031  0.02433  0.1844
sit55   0.25397  0.08795  0.41940  0.2936
sit56   0.09179  0.25035 -0.13079 -0.6751
sit57   0.17629 -0.32619 -0.15688 -0.2169
sit58  -0.11508  0.78168 -0.26250 -0.1136
sit59   0.21912 -0.01360  0.62782 -0.0838
sit60   0.00270  0.43633 -0.56751 -0.0798
sit61  -0.02602  1.11995  0.04927  0.0386
sit62   0.10407  0.02671 -0.21596  0.1125
sit63   0.13274  0.74467  0.80643  0.1282
sit64   0.16992  0.07858  0.07230 -0.4620
sit65  -0.00788  0.18525 -0.20528  0.3057
sit66   0.20673 -0.21481  0.53024  0.2942
sit67   0.08271  0.08284 -0.51693 -0.5368
sit68   0.03750  0.33424  0.31807 -0.5755
sit69   0.28930  0.68454  0.50791  0.6332
sit70   0.03895  0.54967  0.18201 -0.1450
sit71   0.17420 -0.16734 -0.64926 -0.2334
sit72   0.11247  0.17610  0.27902  0.3183
sit73   0.29145  0.39384  0.38797 -0.0279
sit74   0.14945  0.17570  0.30739 -0.7686
sit75   0.16593  0.02676  0.46971  0.1218
sit76   0.20646 -0.10583  0.49767  0.2851
sit77   0.29672  0.03260  0.76576  0.1112
sit78   0.32079 -0.13980  0.27467  0.1873
sit79   0.15699  0.09534 -0.09042 -0.1021
sit80  -0.00951  0.44675  0.33654  0.1816
sit81   0.03089  0.65924  0.15795 -0.0264
sit82   0.00554  0.66354  0.25438 -0.0919
sit83   0.05704  0.32798  0.15924  0.0663
sit84   0.25058  0.26747 -0.11090 -0.5157
sit85   0.05289  0.12143 -0.70057 -0.7143
sit86   0.10134 -0.35681 -0.47456 -0.3074
sit87   0.24766 -0.22029  0.41680  0.1043
sit88   0.24667  0.58359  0.72484  0.3836
sit89   0.01643  0.09262 -0.30706 -0.4124
sit90   0.06694  0.56094 -0.09416  0.0250
sit91   0.06590  0.47262 -0.09950 -0.7587
sit92   0.14749 -0.01052  0.02157 -0.4140
sit93   0.07947  0.41708  0.20998  0.0183
sit94  -0.08553  0.85207 -0.11144  0.0549
sit95   0.06815  0.36110 -0.13784 -0.3011
sit96   0.02157  0.07646 -0.13583 -0.6446
sit97   0.05378  0.16243 -0.16451 -0.3717
sit98   0.13611  0.06535  0.28607 -0.0557
sit99  -0.10572  0.65144 -0.20051  0.5605
sit100  0.06063  0.25270 -0.09676 -0.1643
sit101  0.43559 -0.36730 -1.05878 -0.1380
sit102  0.27343  0.29490 -0.55831 -0.1136
sit103  0.52077 -0.23715  0.21369  0.1659
sit104  0.34009  0.01983 -0.17232 -0.6609
sit105  0.44108 -0.12450 -0.41663 -0.0457
sit106  0.64985 -0.33775  0.61323 -0.2842
sit107  0.08667  0.65891 -1.03929 -0.3731
sit108  0.54372 -0.17726  0.68631 -0.6672
sit109  0.47388  0.30021  0.41491 -0.2425
sit110  0.53364 -0.81062 -0.41866  0.2939
sit111  0.32215 -0.29233 -0.29972  0.3023
sit112  0.37847  0.17795 -0.02442  0.1635
sit113  0.44488 -0.17691 -0.02774  0.4104
sit114  0.29758  0.49044 -0.61106  0.2779
sit115  0.34658  0.18663 -1.05717  0.7727
sit116  0.37550 -0.28536 -0.67232  0.5378
sit117  0.34748 -0.10787 -0.03942 -0.4354
sit118  0.57298 -1.07884  0.13467 -0.7675
sit119  0.78182 -0.00750  0.74065  0.1267
sit120  0.29844  0.72020  0.28174 -0.1827
sit121  0.48120 -0.38419 -0.24727  0.4708
sit122  0.23095  0.24127 -0.87209  0.0778
sit123  0.68428 -0.17455  0.90294 -0.3569
sit124  0.31484  0.20331  0.00572  0.3923
sit125  0.40163 -0.42785 -0.31430 -0.1728
sit126  0.46151 -0.42526  0.44228 -0.6120
sit127  0.27750  0.13351 -0.13684  0.3516
sit128  0.24110 -0.02715 -0.35565 -0.0243
sit129  0.42232  0.07906 -0.28503  0.0871
sit130  0.44010 -0.23727  0.75363 -0.5836
sit131  0.57525 -0.10941  0.76646 -0.0502
sit132  0.54431 -1.10824  0.51967 -0.5933
sit133  0.43988  0.07534 -0.37295  0.2803
sit134  0.26310  0.12361  0.19323 -0.5223
sit135  0.28396  0.34235  0.17347 -1.3720
sit136  0.66093 -0.36155  0.57173  0.8294
sit137  0.37223 -0.45091 -0.99607  0.0998
sit138  0.31793 -0.17825 -0.19048 -0.6038
sit139  0.21840 -0.00727 -0.43896  0.0147
sit140  0.43736 -0.28531  0.01334  0.5471
sit141  0.47580 -0.25904 -0.45107  0.6939
sit142  0.44910 -0.29098 -0.13698  1.3166
sit143  0.27343  0.29490 -0.55831 -0.1136
sit144  0.48188 -0.36607 -0.35610  0.1267
sit145  0.47186 -0.44272 -0.66599  0.6000
sit146  0.44172 -0.16329 -0.26988  1.0911
sit147  0.36947  0.37838  0.02777  0.6172
sit148  0.35922 -0.11354 -0.18974  0.3340
sit149  0.32418 -0.42672 -0.98295  0.0732
sit150  0.22686  0.01027 -0.55630 -0.4571
```
]

---

## Части результатов в `summary()`

- Importance of components --- __собственные числа__ (eigenvalues) и доля объясненной изменчивости
- Species scores --- __факторные нагрузки исходных переменных__ на каждую из компонент
- Site scores --- __факторные координаты объектов__

### Масштабирование --- scaling

- __scaling = "species", correlation = TRUE__ --- отношения между переменными (нагрузки переменных пересчитаны с учетом собственных чисел, интерпретируются как корреляции)
- __scaling = "sites"__ --- отношения между объектами (факторные координаты пересчитаны с учетом соб. чисел)

---

## Что нужно знать, чтобы интерпретировать результаты?

Мы хотим снизить размерность данных и вместо множества исходных признаков получить несколько главных компонент (лучше 2 или 3 для удобства интерпретации).

Эти главные компоненты будут описывать данные почти так же хорошо, как исходные признаки, но при этом будут независимы друг от друга.

Мы сможем трактовать компоненты как сложные признаки и описывать отношения между объектами в терминах этих признаков.

Чтобы все это получилось, нужно ответить на несколько вопросов:

1. Сколько компонент нужно оставить?
2. Сколько общей изменчивости объясняют оставленные компоненты?
3. Что означают получившиеся компоненты?
4. Как располагаются объекты в пространстве главных компонент?

---

## 1. Cколько компонент нужно оставить?

Можно оставить только компоненты, которые объясняют больше изменчивости, чем возможно случайно (по модели сломанной палки), либо только компоненты, которые объясняют суммарно заданный процент общей изменчивости.

Строим график собственных чисел. 


```r
screeplot(ord_iris, bstick = TRUE, type = 'lines')
```

![](07_pca_files/figure-html/unnamed-chunk-17-1.png)&lt;!-- --&gt;

---

## 2. Сколько изменчивости объясняют компоненты?

Изменчивость, объясненная каждой из компонент, в процентах:


```r
eigenvals(ord_iris) / sum(eigenvals(ord_iris)) * 100
```

```
  PC1   PC2   PC3   PC4 
72.96 22.85  3.67  0.52 
```

Первые две компоненты объясняют 96 % общей изменчивости. Поэтому оставим обе, чтобы компоненты объясняли более 90%. 

---

## 3. Что означают получившиеся компоненты?

Факторные нагрузки описывают связь переменных с компонентами

- Вклад переменных в изменчивость вдоль компоненты тем сильнее, чем больше модуль их факторной нагрузки.
- Знак факторной нагрузки означает направление изменения исходной переменной вдоль главной компоненты.

.small[

```r
scores(ord_iris, display = 'species', choices = c(1, 2),
       scaling = 'species', correlation = TRUE)
```

```
          PC1       PC2
s_len  0.3603 -0.146057
s_wid -0.1863 -0.357305
p_len  0.4014 -0.009478
p_wid  0.3906 -0.025906
attr(,"const")
[1] 4.941
```
]

---

## 3. Что означают получившиеся компоненты?

 | PC1 | PC2 
- | ---- | ---- 
s_len | **0.3603** | -0.146057
s_wid | -0.1863 | **-0.357305**
p_len | **0.4014** | -0.009478
p_wid | **0.3906** | -0.025906

- PC1 --- почти все измерения ирисов. Высокие измерения у 3 из 4 измерений: длина чашелистника, длина лепестка и ширина лепестка. Нагрузки с положительным знаком, значит, у больших ирисов будут большие значения по первой компоненте.
- PC2 --- ширина чашелистника. Отрицательный знак, значит, у больших ирисов будут небольшие значения по второй компоненте. 

---


## Можно нарисовать факторные нагрузки на графике

- Чем ближе стрелки исходных признаков к оси компоненты, тем выше их нагрузка.
- Стрелки направлены в сторону увеличения значения исходного признака


```r
biplot(ord_iris, scaling = 'species', correlation = TRUE, 
       main = 'PCA -  species scaling', display = 'species')
```

![](07_pca_files/figure-html/unnamed-chunk-20-1.png)&lt;!-- --&gt;


---

## График факторных нагрузок в ggplot2


```r
library(ggplot2)
theme_set(theme_bw())
library(ggrepel) # для подписей (geom_text_repel)
library(grid) # для стрелочек
# параметры стрелочек
ar &lt;- arrow(length = unit(0.1, 'cm'))
# датафрейм с факторными нагрузками
df_load_iris &lt;- data.frame(scores(ord_iris, display = 'species',
         choices = c(1, 2), scaling = 'species', correlation = TRUE))
# график
ggloadings &lt;- ggplot(df_load_iris) + 
  geom_text_repel(aes(x = PC1, y = PC2,
    label = rownames(df_load_iris)), segment.alpha = 0.5, size = 3) + 
  geom_segment(aes(x = 0, y = 0, xend = PC1, yend = PC2), 
    colour = 'grey40', arrow = ar) + 
  coord_equal(xlim = c(-0.8, 0.8), ylim = c(-0.8, 0.8))
ggloadings
```

---

## График факторных нагрузок в ggplot2

&lt;img src="07_pca_files/figure-html/ggload-iris-1.png" width="60%" /&gt;

---

## Интерпретируем компоненты по графику факторных нагрузок

.pull-left[
- PC1 --- почти все измерения ирисов. Высокие измерения у 3 из 4 измерений: длина чашелистника, длина лепестка и ширина лепестка. Нагрузки с положительным знаком, значит, у больших ирисов будут большие значения по первой компоненте.
- PC2 --- ширина чашелистника. Отрицательный знак, значит, у больших ирисов будут небольшие значения по второй компоненте. 
]

.pull-right[
![](07_pca_files/figure-html/ggload-pos-1.png)&lt;!-- --&gt;
]

---

## 4. Значения факторов (= факторные координаты) --- координаты объектов в пространстве главных компонент

.small[

```r
# Координаты можно добыть так (но сейчас нам нужен только график)
scores(ord_iris, display = 'sites',  choices = c(1, 2), scaling = 'sites')
```

```
             PC1       PC2
sit1   -0.456822 -0.096828
sit2   -0.419759  0.135982
sit3   -0.476898  0.068968
sit4   -0.463818  0.120503
sit5   -0.482065 -0.130476
sit6   -0.418684 -0.300388
sit7   -0.492995 -0.009610
sit8   -0.450396 -0.045012
sit9   -0.470930  0.224977
sit10  -0.440609  0.094607
sit11  -0.436975 -0.210527
sit12  -0.469213 -0.026844
sit13  -0.447492  0.146984
sit14  -0.531133  0.193949
sit15  -0.443517 -0.375199
sit16  -0.456320 -0.541861
sit17  -0.445301 -0.299265
sit18  -0.441824 -0.098606
sit19  -0.382968 -0.283412
sit20  -0.472690 -0.227503
sit21  -0.386146 -0.082472
sit22  -0.445185 -0.186408
sit23  -0.559624 -0.092454
sit24  -0.366851 -0.017258
sit25  -0.449250 -0.027686
sit26  -0.393715  0.126196
sit27  -0.413746 -0.048848
sit28  -0.437432 -0.106333
sit29  -0.431580 -0.063180
sit30  -0.456935  0.068125
sit31  -0.431692  0.101773
sit32  -0.369458 -0.085465
sit33  -0.527471 -0.361789
sit34  -0.493428 -0.433832
sit35  -0.425611  0.092829
sit36  -0.445346  0.041575
sit37  -0.412535 -0.133446
sit38  -0.509798 -0.119474
sit39  -0.490091  0.182386
sit40  -0.437661 -0.054237
sit41  -0.461214 -0.089100
sit42  -0.374809  0.471489
sit43  -0.515104  0.096641
sit44  -0.396257 -0.095275
sit45  -0.431075 -0.230404
sit46  -0.417496  0.143429
sit47  -0.481034 -0.226006
sit48  -0.482979  0.077911
sit49  -0.449710 -0.201302
sit50  -0.444544 -0.001859
sit51   0.222245 -0.174074
sit52   0.147521 -0.119942
sit53   0.250323 -0.124316
sit54   0.082195  0.353888
sit55   0.216938  0.042041
sit56   0.078404  0.119674
sit57   0.150585 -0.155929
sit58  -0.098300  0.373661
sit59   0.187171 -0.006500
sit60   0.002305  0.208576
sit61  -0.022228  0.535364
sit62   0.088894  0.012768
sit63   0.113385  0.355970
sit64   0.145146  0.037564
sit65  -0.006728  0.088553
sit66   0.176582 -0.102685
sit67   0.070651  0.039599
sit68   0.032034  0.159777
sit69   0.247118  0.327229
sit70   0.033266  0.262754
sit71   0.148801 -0.079994
sit72   0.096074  0.084179
sit73   0.248951  0.188265
sit74   0.127656  0.083991
sit75   0.141737  0.012791
sit76   0.176353 -0.050589
sit77   0.253455  0.015584
sit78   0.274009 -0.066830
sit79   0.134100  0.045573
sit80  -0.008121  0.213558
sit81   0.026383  0.315132
sit82   0.004731  0.317190
sit83   0.048722  0.156783
sit84   0.214038  0.127855
sit85   0.045180  0.058048
sit86   0.086563 -0.170566
sit87   0.211543 -0.105305
sit88   0.210697  0.278968
sit89   0.014037  0.044277
sit90   0.057181  0.268143
sit91   0.056294  0.225925
sit92   0.125984 -0.005027
sit93   0.067883  0.199375
sit94  -0.073057  0.407308
sit95   0.058212  0.172613
sit96   0.018429  0.036549
sit97   0.045934  0.077644
sit98   0.116266  0.031240
sit99  -0.090301  0.311404
sit100  0.051786  0.120797
sit101  0.372075 -0.175576
sit102  0.233561  0.140972
sit103  0.444833 -0.113365
sit104  0.290498  0.009478
sit105  0.376764 -0.059515
sit106  0.555091 -0.161454
sit107  0.074033  0.314977
sit108  0.464434 -0.084733
sit109  0.404777  0.143507
sit110  0.455829 -0.387495
sit111  0.275173 -0.139739
sit112  0.323283  0.085063
sit113  0.380009 -0.084569
sit114  0.254183  0.234444
sit115  0.296045  0.089212
sit116  0.320741 -0.136408
sit117  0.296808 -0.051562
sit118  0.489424 -0.515714
sit119  0.667813 -0.003587
sit120  0.254919  0.344274
sit121  0.411036 -0.183654
sit122  0.197272  0.115333
sit123  0.584497 -0.083437
sit124  0.268932  0.097188
sit125  0.343062 -0.204522
sit126  0.394215 -0.203283
sit127  0.237035  0.063821
sit128  0.205940 -0.012979
sit129  0.360735  0.037793
sit130  0.375924 -0.113422
sit131  0.491366 -0.052301
sit132  0.464936 -0.529766
sit133  0.375733  0.036016
sit134  0.224739  0.059087
sit135  0.242556  0.163654
sit136  0.564551 -0.172829
sit137  0.317953 -0.215548
sit138  0.271566 -0.085210
sit139  0.186550 -0.003474
sit140  0.373583 -0.136384
sit141  0.406415 -0.123829
sit142  0.383616 -0.139097
sit143  0.233561  0.140972
sit144  0.411609 -0.174991
sit145  0.403054 -0.211632
sit146  0.377307 -0.078056
sit147  0.315598  0.180874
sit148  0.306841 -0.054275
sit149  0.276910 -0.203984
sit150  0.193778  0.004908
attr(,"const")
[1] 4.941
```
]

---

## График факторных координат (= график ординации)


```r
biplot(ord_iris, scaling = 'sites', display = 'sites', 
       type = 't', main = 'PCA - sites scaling')
```

&lt;img src="07_pca_files/figure-html/unnamed-chunk-22-1.png" style="display: block; margin: auto;" /&gt;

---

## График факторных координат в ggplot2


```r
# данные для графика: факторные координаты и исходные переменные
df_scores_iris &lt;- data.frame(iris, 
                        scores(ord_iris, display = 'sites', scaling = 'sites', 
                               choices = c(1, 2)))
# график ординации
ggscores &lt;- ggplot(df_scores_iris, aes(x = PC1, y = PC2, 
                                  colour = Sp)) + 
  geom_point(size = 2) + coord_equal()
ggscores
```

&lt;img src="07_pca_files/figure-html/ggscor-iris-1.png" style="display: block; margin: auto;" /&gt;

---

## Для удобства интерпретации ординации, располагаем ее рядом с графиком факторных нагрузок

.pull-left[


```r
library(cowplot)
plot_grid(ggloadings, ggscores, labels = 'AUTO')
```

![](07_pca_files/figure-html/unnamed-chunk-23-1.png)&lt;!-- --&gt;
]

.pull-right[
Или отобразить одновременно на графике...
![](07_pca_files/figure-html/load_scores_iris-1.png)&lt;!-- --&gt;
]


---

## Отображение нагрузок и координат одновременно на графике

.pull-left[

```r
ggplot(df_load_iris) + 
  geom_point(df_scores_iris, mapping = aes(x = PC1, y = PC2, colour = Sp), size = 2) + 
  geom_segment(aes(x = 0, y = 0, xend = PC1, yend = PC2), 
    colour = 'grey40', arrow = ar) + 
  coord_equal(xlim = c(-0.8, 0.8), ylim = c(-0.8, 0.8)) +
  geom_text_repel(aes(x = PC1, y = PC2,
    label = rownames(df_load_iris)), size = 3) + coord_equal()
```

![](07_pca_files/figure-html/load_scores_iris-1.png)&lt;!-- --&gt;
]

.pull-right[
Первые две компоненты объясняют почти 96% общей изменчивости. Первая компонента (73%) связана с длиной чашелистника, длиной и шириной лепестка. Вторая компонента (23%) описывает ширину чашелистника. Внутри видов ирисы различаются по ширине чашелистника (об этом говорит разброс точек вдоль второй компоненты). Ирисы вида setosa не похожи versicolor и virginica: у них относительно более короткие чашелистник и лепестки, и более узкие лепестки.
]

---

## Факторные координаты можно использовать для снижения размерности данных

Было 7 скоррелированных признаков, стало 2 __независимых__ (они ведь перпендикулярны) главных компоненты

Значения факторных координат можно использовать в анализах, где нужна независимость переменных:

- Множественная регрессия
- Дискриминантный анализ (например, генетические данные)
- Дисперсионный анализ
- Корреляция с другими признаками, которые не были использованы в анализе главных компонент, и т.д., и т.п.

---

## Условия применимости анализа главных компонент

Похожи на условия применимости множественной линейной регрессии

- Линейные связи между переменными (т.к. матрица корреляций или ковариаций)
- Исключить наблюдения, в которых есть пропущенные значения
- Если много нулей --- трансформация данных (например, трансформация Хелингера)
- Если очень много нулей --- удалить такие переменные из анализа

---

## Пример: Морфометрия поссумов

.pull-left[

![](images/possum.jpg)

.tiny[
pos by Hasitha Tudugalle on [Flickr](https://www.flickr.com/photos/hasitha\_tudugalle/6037880962)
]
]

.pull-right[

В датафрейме содержатся данные об измерениях поссумов в разных частях тела. Кроме того, есть ещё и факторные переменные: 

- site --- места, в которых поссумы были пойманы (7 локаций)

- Pop --- популяция, к которой поссумы относятся (`Victoria` или `other`)

- sex --- пол поссума (`f` или `m`)

.tiny[
Данные Lindenmayer et al. (1995)
]
]

---

## Знакомимся с данными


```r
library(DAAG)
data(possum)
colnames(possum)
```

```
 [1] "case"     "site"     "Pop"      "sex"      "age"      "hdlngth"  "skullw"  
 [8] "totlngth" "taill"    "footlgth" "earconch" "eye"      "chest"    "belly"   
```

```r
colSums(is.na(possum))
```

```
    case     site      Pop      sex      age  hdlngth   skullw totlngth    taill 
       0        0        0        0        2        0        0        0        0 
footlgth earconch      eye    chest    belly 
       1        0        0        0        0 
```

```r
# оставим только строки с полными наблюдениями
pos &lt;- possum[complete.cases(possum), ]
```

---

## Знакомимися с данными


```r
# поссумы из разных сайтов из 2 популяций
table(pos$site, pos$Pop)
```

```
   
    Vic other
  1  33     0
  2  10     0
  3   0     7
  4   0     7
  5   0    13
  6   0    13
  7   0    18
```

---

## Знакомимся с данными


```r
# половой состав выборок из разных сайтов
table(pos$sex, pos$site, pos$Pop)
```

```
, ,  = Vic

   
     1  2  3  4  5  6  7
  f 19  4  0  0  0  0  0
  m 14  6  0  0  0  0  0

, ,  = other

   
     1  2  3  4  5  6  7
  f  0  0  3  2  6  4  4
  m  0  0  4  5  7  9 14
```

---

## Как связаны признаки между собой?

Можно построить серию графиков с признаками во всех возможных комбинациях.

.pull-left[

```r
# сколько всего сайтов
n_sites &lt;- length(unique(pos$site))
# цвета из Брюеровской палитры 'Set1'
library(RColorBrewer)
cols &lt;- brewer.pal(n = n_sites, name = 'Set1')
# график морфометрических переменных
pairs(pos[, 6:14], col = cols[pos$site], 
      pch =  as.numeric(pos$sex))
```
]

.pull-right[
![](07_pca_files/figure-html/pairs-pos-1.png)&lt;!-- --&gt;
]

---

## Анализ главных компонент


```r
library(vegan)
# ординация, используем морфометрические переменные (с hdlngth по belly)
ord_pos &lt;- rda(pos[, 6:14], scale = TRUE)
```

.small[

```r
summary(ord_pos)
```

```

Call:
rda(X = pos[, 6:14], scale = TRUE) 

Partitioning of correlations:
              Inertia Proportion
Total               9          1
Unconstrained       9          1

Eigenvalues, and their contribution to the correlations 

Importance of components:
                        PC1   PC2   PC3    PC4    PC5    PC6    PC7    PC8   PC9
Eigenvalue            3.931 1.949 0.908 0.7516 0.5769 0.3099 0.2671 0.1625 0.144
Proportion Explained  0.437 0.217 0.101 0.0835 0.0641 0.0344 0.0297 0.0181 0.016
Cumulative Proportion 0.437 0.653 0.754 0.8378 0.9019 0.9363 0.9660 0.9840 1.000

Scaling 2 for species and site scores
* Species are scaled proportional to eigenvalues
* Sites are unscaled: weighted dispersion equal on all dimensions
* General scaling constant of scores:  5.477 


Species scores

            PC1    PC2     PC3     PC4      PC5     PC6
hdlngth  -1.571 -0.161  0.2622 -0.0863  0.36124  0.6071
skullw   -1.398 -0.283  0.4374 -0.4867  0.71640 -0.0395
totlngth -1.514 -0.199 -0.5927  0.5374  0.15919  0.0205
taill    -0.699 -1.227 -0.9306  0.4987  0.02520 -0.1672
footlgth -1.111  1.267 -0.1376  0.4228 -0.00248 -0.0573
earconch -0.502  1.627 -0.0381  0.4197 -0.05338  0.0126
eye      -0.672 -0.704  1.2344  0.8453 -0.30676 -0.2280
chest    -1.482  0.226 -0.0196 -0.6683 -0.11644 -0.6912
belly    -1.328 -0.209 -0.0784 -0.4553 -1.06894  0.3180


Site scores (weighted sums of species scores)

           PC1      PC2      PC3      PC4      PC5     PC6
C3    -0.54593  0.65362  0.21682 -0.05006 -0.26763  0.2616
C5    -0.36326  0.30812  0.21830  0.49538 -0.13764 -0.6562
C10   -0.83389  0.23176 -0.44819  0.50304  0.14713 -0.9356
C15   -0.47327  0.44514 -0.40101  0.62016 -0.21662 -0.2509
C23   -0.05218  0.57443  0.15362 -0.03227 -0.34642 -0.5821
C24   -0.22847  0.84735 -0.39790 -0.06655 -0.05472 -0.6800
C26   -0.45148  0.54015 -0.21803 -0.59919 -0.04345 -0.1014
C27   -0.46314  0.57355 -0.37887  0.00613 -0.03264 -0.0498
C28   -0.32464  0.41518 -0.09318  0.59142 -0.16363 -0.2547
C31   -0.14450  0.44976 -0.43668  0.19420  0.30053 -0.2910
C32   -0.60439  0.44099 -0.56687  0.09937 -0.28081 -1.2769
C34   -0.28380  0.42679  0.05771  0.32577 -0.12437  0.1748
C36   -0.28953  0.17378  0.51764  0.25899  0.52350  0.2216
C37   -0.37937  0.67066  0.01058  0.46760  0.45257  0.0381
C39   -0.12767  0.50040  0.79176 -0.31278 -0.60194  0.0784
C40    0.05917  0.77021  0.07912 -0.22862 -0.04122 -0.2680
C45   -0.65345  0.48527  0.33926 -0.49861  1.72784 -0.5458
C47   -0.24076  0.77366  0.01852  0.60613 -0.05011 -0.2356
C48   -0.22306  0.76810  0.12848  0.43546 -0.00945  0.0231
C50   -0.40825  0.30609 -0.13613  0.51595 -0.70998  0.5359
C54   -1.09172  0.42429 -1.20085  0.02779 -0.99100  0.2889
C55   -0.71198  0.02010 -0.05352  0.68442 -0.44960  0.1714
C58   -0.27211  0.56738  0.08499  0.25069 -0.68704 -0.0895
C59   -0.01931  0.84473  0.93730  0.52900 -0.32282  0.1819
C60   -0.64044  0.51602  0.04750 -0.49926 -0.17945 -0.4030
C61   -0.70938  0.73179  0.05656 -0.22316 -0.73337  0.5537
C63    0.65792  0.58360 -0.04244  0.61026  0.70360  0.7991
C64   -0.00311  0.75792  0.48561  0.37665  0.48298  0.0144
A1     0.15269  0.77991 -0.22457  0.40207  0.24249  1.2863
A2     0.38496  0.67406  0.33292 -0.02575 -0.36193  1.1874
A3    -0.00279  0.32902 -0.59668  0.57350  0.16203  0.0473
A4    -0.53773  0.29353 -0.74324  0.68405 -0.11287 -0.0566
AD1    0.28117  0.37099 -0.31332  0.98792  0.32089  0.5691
BB4    0.28721  0.70968 -0.21456  0.54750  0.63438 -0.3268
BB13  -0.33213  0.56254  0.87006  0.17946 -0.71885  0.1025
BB15  -0.24436  0.60234  0.25074 -0.00181 -0.33152  1.1044
BB17   0.34791  0.82625 -0.23470 -0.52513 -0.15495 -0.5603
BB25   0.32013  0.24111  0.85253  0.07244  0.12551 -0.3978
BB31   1.32499  1.11798 -0.13419 -0.15774  0.54477 -0.8209
BB33   0.28758  0.73520 -0.42989 -0.08272  0.34523 -0.2115
BB38   0.98628  0.68558  0.51926 -1.09035 -0.83397  0.0605
BB40   0.40392  1.02841  0.27703 -1.19450  0.03656 -0.5765
BB44   0.31363  0.92469  0.45582 -0.24060 -0.11884 -0.1400
WW1    0.27957 -0.31009 -0.29965  0.32695 -0.34821  0.3156
WW2   -0.44485 -0.29740  1.76687 -0.72221  0.21707  0.7025
WW3   -0.36998 -0.27454  0.57918 -0.63505 -0.39655 -0.2661
WW4   -0.08390 -0.29649 -0.29111 -0.38443 -0.78997 -0.1157
WW5   -0.35723 -0.68952  1.36749 -0.52337 -1.12800  0.4266
WW6   -0.62205 -0.72815 -0.14029  0.19711  0.78621 -0.1018
WW7   -0.18359 -0.48966  0.31030  0.63059 -0.11074  0.1409
BR1   -1.08942 -0.96447  0.13286  0.55687 -0.15947 -0.9365
BR2   -1.16855 -0.42692  0.59806 -0.35282  0.44192  0.5009
BR3   -0.64389 -0.43851  0.46978  0.47522  1.08573  0.5321
BR4   -0.80953 -0.64996 -0.97505 -0.76577 -0.75297 -0.3956
BR5   -0.58613 -0.39741 -0.33750 -0.91210  0.98419 -0.8789
BR6   -1.29609 -0.42800 -0.57576 -0.67068  0.65794  0.1057
BR7    0.25202 -0.41712 -0.50286  0.06157  0.71678 -0.1514
CD1    0.06510 -0.55023  0.14155 -0.29413  0.76686  0.4561
CD2   -0.02732 -0.85553 -0.01861  0.27184  0.16171 -0.6296
CD3    0.31849 -0.38352 -0.09783  0.49099  0.80589 -0.1191
CD4   -0.11979 -0.84513  0.60686  0.75256 -0.09234  0.7839
CD5   -0.31166 -0.44564 -0.61056 -1.13009 -0.92575  0.2736
CD6    0.25564 -0.47014  0.33821 -0.19515 -0.62247 -0.0773
CD7    0.16700 -0.46001  0.87242  0.08865  0.49561 -0.6449
CD8    0.00996 -0.72787  0.75475  0.83551  0.20914 -0.5818
CD9   -0.20440 -0.35926 -0.03209 -0.41436 -0.15917  0.5873
CD10   0.17730 -0.26391 -0.94110 -0.89141 -0.04870  0.4169
CD11  -0.14978 -0.76382 -0.54524 -0.09083 -0.09166 -0.1879
CD12   1.04005 -0.17703  0.00246 -0.60239 -0.29053 -0.4671
CD13   1.07884 -0.20636  0.32221  0.90451 -0.28010 -1.1490
BSF1   0.57932 -0.40306 -0.34567 -0.19005 -1.06420 -0.0512
BSF2  -0.14494 -0.59868  0.58844  0.58661 -0.17001  0.1788
BSF3  -0.13366 -0.97004  0.39220  1.27276 -0.41962 -0.5057
BSF4   0.24395 -0.62261  0.80281 -0.18240 -0.67155  0.9904
BSF5   1.23411 -0.07484 -0.64084 -0.05052  0.19809  0.3126
BSF6   1.26830 -0.33197 -0.08393  0.56632 -0.26346  0.2606
BSF7   0.84972 -0.46968 -0.26167  0.48711 -0.32891 -0.0310
BSF8   0.03643 -0.79037  0.61289  0.12057 -1.00095 -0.6989
BSF9   0.75470 -0.52961  0.26752 -0.28944 -0.67503 -0.7792
BSF10  0.85910 -0.25974 -0.06418 -0.44020  0.35056  0.1995
BSF11  0.80639 -0.43705  0.86367  0.27595  0.09455 -0.6250
BSF12  0.08263 -0.67251 -1.03121  0.28010  0.20189 -0.7625
BSF13  0.65376 -0.53049 -0.91925 -0.31831 -0.08187 -0.2749
BTP1  -0.71714 -0.55064 -0.72273  0.42332  0.26232  1.2763
BTP3   0.19901 -0.55699  0.22574  0.40218  0.13658 -0.4138
BTP4   0.01056 -0.00942  0.44867 -1.04029  0.86019  0.2652
BTP5   0.23272 -0.20106 -0.44313  0.13589 -0.14507  0.4669
BTP6  -0.19419 -0.31844  0.03905  0.02016  0.79950  1.0714
BTP7   0.35874 -0.02388 -0.14623 -0.00507  0.24033  0.1161
BTP8   0.80175 -0.19183 -0.91099 -0.46627  0.14676  0.6908
BTP9   0.08639 -0.13068  0.17440 -1.26038 -0.46694 -0.2468
BTP10  0.17728 -0.34640 -0.16582 -0.05014  0.30201 -0.3071
BTP12  0.25823 -0.09970 -0.33724 -0.24042  0.03127  1.2290
BTP13  0.49393 -0.31603 -0.45186  0.19881 -0.18188  0.3957
BTP14 -0.21081 -0.21789  0.85552 -1.69506  1.54176 -0.3214
BTP15  0.00947 -0.45727 -0.59107 -0.78290 -0.38675  0.1896
BTP16  0.82458 -0.03505  0.22943  0.42705  0.91325  0.2778
BTP17  0.52811 -0.20837 -0.64822 -0.10965 -0.42449  0.1484
BTP19  0.43814 -0.25338 -1.02734 -0.19491  0.71614  0.7657
BTP20  0.60913 -0.28837  0.43513  0.14696  0.39280  0.1011
BTP21 -0.32298 -0.46938 -0.47681 -0.25154  0.28715 -0.4475
```
]

---

## 1. Cколько компонент нужно оставить?

График собственных чисел.


```r
screeplot(ord_pos, bstick = TRUE, type = 'lines')
```

![](07_pca_files/figure-html/unnamed-chunk-28-1.png)&lt;!-- --&gt;

---

## 2. Сколько изменчивости объясняют компоненты?

Посмотрев на broken stick model, решили оставить 2 компоненты. Смотрим, сколько же изменчивости они объясняют.


```r
eigenvals(ord_pos) / sum(eigenvals(ord_pos)) * 100
```

```
  PC1   PC2   PC3   PC4   PC5   PC6   PC7   PC8   PC9 
43.68 21.65 10.09  8.35  6.41  3.44  2.97  1.81  1.60 
```

Первые две компоненты объясняют 65 % общей изменчивости.

---

## 3. Факторные нагрузки

.small[

```r
scores(ord_pos, display = 'species', choices = c(1, 2, 3),
       scaling = 'species', correlation = TRUE)
```

```
             PC1      PC2       PC3
hdlngth  -0.4714 -0.04838  0.078656
skullw   -0.4194 -0.08481  0.131206
totlngth -0.4542 -0.05970 -0.177802
taill    -0.2098 -0.36809 -0.279173
footlgth -0.3334  0.38004 -0.041290
earconch -0.1505  0.48821 -0.011420
eye      -0.2017 -0.21131  0.370315
chest    -0.4447  0.06787 -0.005893
belly    -0.3984 -0.06277 -0.023506
attr(,"const")
[1] 5.477
```
]

- PC1 --- это физические размеры поссумов (высокие нагрузки у переменных длина головы, общая длина, измерения черепа, груди и живота). У нагрузок отрицательный знак, значит у крупных поссумов будут маленькие значения координат по первой компоненте.
- PC2 --- длина ушей, ног и хвоста. Высокие значения по этой компоненте у поссумов с большими ушами, длинными ногами и коротким хвостом.
- PC3 --- размеры глаз. Высокие значения по этой компоненте будут у поссумов с большими глазами.

---

## Можно нарисовать факторные нагрузки на графике

- Чем ближе стрелки исходных признаков к оси компоненты, тем выше их нагрузка.
- Стрелки направлены в сторону увеличения значения исходного признака


```r
biplot(ord_pos, scaling = 'species', correlation = TRUE, 
       main = 'PCA -  species scaling', display = 'species')
```

![](07_pca_files/figure-html/unnamed-chunk-31-1.png)&lt;!-- --&gt;


---

## График факторных нагрузок в ggplot2


```r
library(ggplot2)
theme_set(theme_bw())
library(ggrepel) # для подписей (geom_text_repel)
library(grid) # для стрелочек
# параметры стрелочек
ar &lt;- arrow(length = unit(0.1, 'cm'))
# датафрейм с факторными нагрузками
df_load_pos &lt;- data.frame(scores(ord_pos, display = 'species',
         choices = c(1, 2), scaling = 'species', correlation = TRUE))
# график
ggloadings &lt;- ggplot(df_load_pos) + 
  geom_text_repel(aes(x = PC1, y = PC2,
    label = rownames(df_load_pos)), segment.alpha = 0.5, size = 3) + 
  geom_segment(aes(x = 0, y = 0, xend = PC1, yend = PC2), 
    colour = 'grey40', arrow = ar) + 
  coord_equal(xlim = c(-0.8, 0.8), ylim = c(-0.8, 0.8))
ggloadings
```

---

## График факторных нагрузок в ggplot2

&lt;img src="07_pca_files/figure-html/ggload-pos-1.png" width="60%" /&gt;

---

## Интерпретируем компоненты по графику факторных нагрузок

.pull-left[
- PC1 --- это физические размеры поссумов (высокие нагрузки у переменных длина головы, общая длина, измерения черепа, груди и живота). У нагрузок отрицательный знак, значит у крупных поссумов будут маленькие значения координат по первой компоненте.
- PC2 --- длина ушей, ног и хвоста. Высокие значения по этой компоненте у поссумов с большими ушами, длинными ногами и коротким хвостом.
]

.pull-right[
![](07_pca_files/figure-html/ggload-pos-1.png)&lt;!-- --&gt;
]

---

## 4. Значения факторов (= факторные координаты) --- координаты объектов в пространстве главных компонент

.small[

```r
# Координаты можно добыть так (но сейчас нам нужен только график)
scores(ord_pos, display = 'sites',  choices = c(1, 2, 3), scaling = 'sites')
```

```
            PC1       PC2       PC3
C3    -0.360819  0.304131  0.068882
C5    -0.240088  0.143367  0.069353
C10   -0.551140  0.107837 -0.142387
C15   -0.312800  0.207126 -0.127399
C23   -0.034486  0.267285  0.048805
C24   -0.151005  0.394274 -0.126411
C26   -0.298397  0.251334 -0.069267
C27   -0.306099  0.266872 -0.120363
C28   -0.214566  0.193184 -0.029604
C31   -0.095501  0.209273 -0.138730
C32   -0.399460  0.205195 -0.180091
C34   -0.187569  0.198586  0.018334
C36   -0.191356  0.080859  0.164452
C37   -0.250735  0.312059  0.003360
C39   -0.084378  0.232837  0.251536
C40    0.039106  0.358378  0.025134
C45   -0.431886  0.225797  0.107782
C47   -0.159125  0.359987  0.005883
C48   -0.147426  0.357401  0.040818
C50   -0.269824  0.142425 -0.043247
C54   -0.721545  0.197425 -0.381501
C55   -0.470570  0.009351 -0.017002
C58   -0.179847  0.264002  0.027001
C59   -0.012764  0.393053  0.297774
C60   -0.423283  0.240103  0.015092
C61   -0.468845  0.340503  0.017970
C63    0.434840  0.271552 -0.013482
C64   -0.002056  0.352661  0.154275
A1     0.100915  0.362892 -0.071345
A2     0.254432  0.313644  0.105768
A3    -0.001846  0.153094 -0.189561
A4    -0.355399  0.136578 -0.236122
AD1    0.185835  0.172623 -0.099539
BB4    0.189828  0.330216 -0.068164
BB13  -0.219516  0.261749  0.276412
BB15  -0.161504  0.280269  0.079658
BB17   0.229941  0.384455 -0.074561
BB25   0.211584  0.112188  0.270842
BB31   0.875720  0.520198 -0.042632
BB33   0.190072  0.342089 -0.136572
BB38   0.651861  0.319004  0.164967
BB40   0.266959  0.478522  0.088011
BB44   0.207286  0.430262  0.144811
WW1    0.184773 -0.144287 -0.095196
WW2   -0.294015 -0.138382  0.561323
WW3   -0.244531 -0.127742  0.184002
WW4   -0.055454 -0.137956 -0.092484
WW5   -0.236102 -0.320836  0.434444
WW6   -0.411132 -0.338812 -0.044569
WW7   -0.121341 -0.227839  0.098582
BR1   -0.720027 -0.448771  0.042208
BR2   -0.772324 -0.198649  0.190001
BR3   -0.425563 -0.204040  0.149246
BR4   -0.535037 -0.302426 -0.309767
BR5   -0.387389 -0.184917 -0.107222
BR6   -0.856619 -0.199148 -0.182914
BR7    0.166566 -0.194086 -0.159757
CD1    0.043023 -0.256022  0.044971
CD2   -0.018057 -0.398079 -0.005911
CD3    0.210501 -0.178453 -0.031079
CD4   -0.079171 -0.393242  0.192795
CD5   -0.205986 -0.207358 -0.193970
CD6    0.168957 -0.218758  0.107447
CD7    0.110374 -0.214042  0.277164
CD8    0.006584 -0.338677  0.239780
CD9   -0.135090 -0.167162 -0.010195
CD10   0.117183 -0.122796 -0.298981
CD11  -0.098997 -0.355409 -0.173221
CD12   0.687399 -0.082374  0.000783
CD13   0.713032 -0.096019  0.102362
BSF1   0.382885 -0.187544 -0.109816
BSF2  -0.095796 -0.278569  0.186945
BSF3  -0.088338 -0.451364  0.124600
BSF4   0.161236 -0.289700  0.255049
BSF5   0.815656 -0.034823 -0.203592
BSF6   0.838254 -0.154467 -0.026663
BSF7   0.561603 -0.218543 -0.083130
BSF8   0.024080 -0.367761  0.194712
BSF9   0.498804 -0.246429  0.084989
BSF10  0.567804 -0.120857 -0.020391
BSF11  0.532966 -0.203359  0.274382
BSF12  0.054610 -0.312919 -0.327608
BSF13  0.432085 -0.246840 -0.292040
BTP1  -0.473977 -0.256216 -0.229606
BTP3   0.131528 -0.259170  0.071717
BTP4   0.006979 -0.004383  0.142541
BTP5   0.153808 -0.093555 -0.140779
BTP6  -0.128345 -0.148171  0.012405
BTP7   0.237104 -0.011113 -0.046458
BTP8   0.529899 -0.089257 -0.289417
BTP9   0.057095 -0.060806  0.055405
BTP10  0.117172 -0.161179 -0.052678
BTP12  0.170674 -0.046389 -0.107138
BTP13  0.326451 -0.147052 -0.143554
BTP14 -0.139327 -0.101384  0.271792
BTP15  0.006261 -0.212769 -0.187780
BTP16  0.544986 -0.016307  0.072887
BTP17  0.349041 -0.096955 -0.205936
BTP19  0.289579 -0.117897 -0.326378
BTP20  0.402589 -0.134179  0.138239
BTP21 -0.213468 -0.218403 -0.151478
attr(,"const")
[1] 5.477
```
]

---

## График факторных координат (= график ординации)


```r
biplot(ord_pos, scaling = 'sites', display = 'sites', 
       type = 't', main = 'PCA - sites scaling')
```

&lt;img src="07_pca_files/figure-html/unnamed-chunk-33-1.png" style="display: block; margin: auto;" /&gt;

---

## График факторных координат в ggplot2


```r
# данные для графика: факторные координаты и исходные переменные
df_scores_pos &lt;- data.frame(pos, 
                        scores(ord_pos, display = 'sites', scaling = 'sites', 
                               choices = c(1, 2)))
# график ординации
ggscores &lt;- ggplot(df_scores_pos, aes(x = PC1, y = PC2, 
                                  colour = Pop, shape = sex)) + 
  geom_point(size = 2) + coord_equal()
ggscores
```

&lt;img src="07_pca_files/figure-html/ggscor-pos-1.png" style="display: block; margin: auto;" /&gt;

---

## Для удобства интерпретации ординации, располагаем ее рядом с графиком факторных нагрузок

.pull-left[


```r
library(cowplot)
plot_grid(ggloadings, ggscores, labels = 'AUTO')
```

![](07_pca_files/figure-html/unnamed-chunk-34-1.png)&lt;!-- --&gt;
]
--

.pull-right[
Первые две компоненты объясняют 65% общей изменчивости. Первая компонента (44%) связана с размером особей. Вторая компонента (21%) описывает пропорции ног, ушей и хвоста. Внутри популяций поссумы мало различаются по этим параметрам (об этом говорит небольшой разброс точек вдоль второй компоненты). Зато поссумы из провинции Виктория не похожи на поссумов из других провинций: у них относительно более крупные уши, длинные ноги и короткие хвосты.
]

---

## Take-home messages

- Метод главных компонент:
    - исследование связей между переменными
    - построение ординации объектов
    - снижение размерности данных
- Собственные числа --- вклад компонент в общую изменчивость
- Факторные нагрузки --- связь исходных переменных с компонентами --- используются для интерпретации
- Значения факторов (факторные координаты) - новые координаты объектов в пространстве уменьшенной размерности
- Значения факторов можно использовать как новые комплексные переменные в других видах анализов.

---

## Дополнительные ресурсы

- Borcard, D., Gillet, F., Legendre, P., 2011. Numerical ecology with R. Springer.
- Legendre, P., Legendre, L., 2012. Numerical ecology. Elsevier.
- Oksanen, J., 2011. Multivariate analysis of ecological communities in R: vegan tutorial. R package version 2–0.
- The Ordination Web Page URL http://ordination.okstate.edu/ (accessed 10.21.13).
- Quinn, G.G.P., Keough, M.J., 2002. Experimental design and data analysis for biologists. Cambridge University Press.
- Zuur, A.F., Ieno, E.N., Smith, G.M., 2007. Analysing ecological data. Springer.

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="assets/macros.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "vs",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>
<!-- https://github.com/fnaufel/xaringan-smartify-->
<script type="text/javascript">
  smartify();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
